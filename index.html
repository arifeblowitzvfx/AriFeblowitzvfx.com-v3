<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ariel (Ari) Feblowitz — Portfolio</title>
<meta name="description" content="Ariel (Ari) Feblowitz — Techvis & Virtual Production Supervisor / Previs-Postvis Artist. Demo reel, credits, projects, and links." />
<meta property="og:title" content="Ariel (Ari) Feblowitz — Portfolio" />
<meta property="og:description" content="Techvis & Virtual Production Supervisor. Demo reel, IMDb credits, projects, and links." />
<meta property="og:type" content="website" />
<meta name="theme-color" content="#0c0f12" />

<!-- Performance preconnects -->
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://docs.googleusercontent.com" crossorigin>
<link rel="preconnect" href="https://img.youtube.com" crossorigin>
<link rel="preconnect" href="https://i.ytimg.com" crossorigin>
<link rel="preconnect" href="https://www.youtube.com" crossorigin>
<link rel="preconnect" href="https://player.vimeo.com" crossorigin>

<style>
  :root{
    --bg:#0b0f11; --panel:#020405; --card:#05090b; --txt:#9fffcf; --muted:#74cdaa;
    --accent:#00ff9c; --grid:clamp(14px, 1.8vw, 24px);
    --radius:18px; --shadow:0 14px 40px rgba(0,0,0,.45);
    --tileH: clamp(120px, 14vw, 220px);
    --tileGap: clamp(10px,1.2vw,16px);
    --speed: 55;
    --stickyTop: 8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    background:
      radial-gradient(1200px 700px at 20% -10%, #123329 0%, transparent 60%),
      radial-gradient(1000px 600px at 120% 10%, #142027 0%, transparent 60%),
      linear-gradient(#080b0e, var(--bg) 40%);
    font:clamp(15px, 1.1vw, 18px)/1.65 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    overflow-y:overlay; letter-spacing:.15px; min-height:100svh;
  }
  /* CRT scanlines + glow (slightly greener/brighter) */
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background-image:
      repeating-linear-gradient(
        to bottom,
        rgba(0,255,156,.24),
        rgba(0,255,156,.24) 2px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 7px
      );
    mix-blend-mode:soft-light; opacity:.9;
    animation:scan 16s linear infinite, glowPulse 7s ease-in-out infinite;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(70% 55% at 50% 45%, rgba(0,255,156,.12), transparent 60%),
      radial-gradient(40% 30% at 60% 35%, rgba(0,255,156,.08), transparent 65%);
    filter:blur(2px); opacity:.95; animation:glowPulse 7s ease-in-out infinite;
  }
  @keyframes scan{0%{transform:translateY(0)}100%{transform:translateY(-26px)}}
  @keyframes glowPulse{0%,100%{opacity:.75}50%{opacity:1}}

  .crt-glow{ text-shadow:
      0 0 7px rgba(0,255,156,.32),
      0 0 13px rgba(0,255,156,.2),
      0 0 22px rgba(0,255,156,.12);
  }

  a{color:var(--accent); text-decoration:none} a:hover{filter:brightness(1.18)}

  /* Banner */
  .banner{position:relative; width:100vw; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw; padding:clamp(8px,1.2vw,14px) 0; z-index:1}
  .rail{height:calc(var(--tileH) + 10px); position:relative; overflow:hidden; border-radius:clamp(10px,1.4vw,18px);
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid rgba(0,255,156,.28); box-shadow:var(--shadow)}
  .rail .scroll{height:100%; display:flex; align-items:center; gap:var(--tileGap); padding:8px; will-change:transform}
  .tile{flex:0 0 auto; height:var(--tileH); position:relative; border-radius:clamp(8px,1vw,14px);
    overflow:hidden; background:#0b1414; border:1px solid rgba(66,255,209,.3)}
  .tile img{height:100%; width:100%; object-fit:cover; object-position:center; display:block}
  .tile::after{content:attr(data-title); position:absolute; left:0; right:0; bottom:0; font-size:clamp(10px,.9vw,12px);
    padding:.45em .6em; color:#caffec; background:linear-gradient(180deg, transparent, rgba(0,0,0,.86)); text-shadow:0 1px 2px rgba(0,0,0,.55)}
  .tile.poster{width:clamp(90px, 8.5vw, 160px)}
  .tile.wide{width:clamp(160px, 16vw, 320px)}

  .banner .ctrl{position:absolute; top:50%; translate:0 -50%; z-index:2; display:grid; place-items:center}
  .banner .prev{left:10px} .banner .next{right:10px}
  .ctrl button{cursor:pointer; border:1px solid rgba(66,255,209,.35); background:rgba(4,10,10,.6); color:var(--txt); border-radius:12px; padding:.5em .7em; backdrop-filter:blur(4px)}
  .ctrl button:hover{border-color:var(--accent)}

  .wrap{max-width:min(1500px, 94vw); margin:0 auto; padding:clamp(16px,2vw,28px); position:relative; z-index:1}

  .nav{display:flex; gap:clamp(8px,1vw,12px); align-items:center; justify-content:space-between; flex-wrap:wrap; margin:clamp(6px,.8vw,10px) 0}
  .brand{display:flex; gap:clamp(10px,1.2vw,14px); align-items:center; flex-wrap:wrap}
  .brand .dot{
    width:clamp(12px,1.2vw,16px); height:clamp(12px,1.2vw,16px); border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #ffd24a, #6b5a1a 70%); /* starts yellow */
    box-shadow:0 0 22px #ffd24a, 0 0 36px rgba(255,210,74,.5);
    animation:blinkFast 1.1s infinite;
  }
  body.ready .brand .dot{
    background:radial-gradient(circle at 30% 30%, var(--accent), #0f4630 70%);
    box-shadow:0 0 22px var(--accent);
    animation:blinkSlow 3.6s infinite;
  }
  @keyframes blinkFast{
    0%,10%,20%{opacity:.2}
    11%,21%{opacity:1}
    50%{opacity:.4}
    55%{opacity:1}
    100%{opacity:.35}
  }
  @keyframes blinkSlow{
    0%,100%{opacity:.55}
    50%{opacity:1}
  }

  .brand h1{margin:0; font-weight:800; font-size:clamp(20px,2.6vw,34px); letter-spacing:.12em; text-transform:uppercase; color:#d9fff1}
  .pill{border:1px dashed rgba(66,255,209,.5); border-radius:999px; padding:.4em .8em; font-size:clamp(11px,1vw,12px); color:var(--muted); backdrop-filter:blur(2px)}

  /* Sticky tabs (always visible) */
  .tabs-bar{
    position:sticky; top:var(--stickyTop); z-index:5;
    display:flex; justify-content:flex-end; flex-wrap:wrap;
    gap:clamp(6px,.8vw,10px); margin:0 0 clamp(12px,1.4vw,16px);
  }
  @media (max-width:920px){ .tabs-bar{justify-content:flex-start} }
  .tab-btn{padding:.6em .9em; border-radius:12px; background:var(--panel); color:var(--txt); border:1px solid rgba(66,255,209,.32); cursor:pointer; font-weight:600}
  .tab-btn.active{outline:1px solid var(--accent); box-shadow:0 0 0 2px rgba(0,255,156,.12) inset}

  /* Hero: Reel dominates, with right gutter */
  .hero{
    margin:clamp(12px,1.6vw,20px) 0;
    display:grid;
    grid-template-columns: minmax(0, 2.1fr) minmax(0, .9fr);
    column-gap: calc(var(--grid) + 18px);
    align-items:start;
  }
  @media (max-width:1200px){ .hero{grid-template-columns:1.5fr .9fr} }
  @media (max-width:920px){ .hero{grid-template-columns:1fr} }

  .card{background:var(--panel); border:1px solid rgba(66,255,209,.34); border-radius:var(--radius); box-shadow:var(--shadow)}
  .pad{padding:clamp(14px,1.6vw,20px)}

  .reel{
    position:relative; aspect-ratio:16/9; border-radius:14px; overflow:hidden;
    background:#000; border:1px solid rgba(0,255,156,.34);
    outline:1px solid rgba(0,255,156,.2);
    box-shadow:0 0 20px rgba(0,255,156,.12) inset, 0 0 18px rgba(0,0,0,.6);
  }
  .reel iframe{position:absolute; inset:0; width:100%; height:100%; display:block; max-width:100%}
  @media (min-height:900px){ .reel{min-height:560px} }

  .badges{display:flex; flex-wrap:wrap; gap:clamp(8px,1vw,12px); margin-top:clamp(8px,1vw,12px)}
  .btn{--b:rgba(66,255,209,.34); display:inline-flex; align-items:center; gap:.5em; border:1px solid var(--b);
    background:linear-gradient(180deg, rgba(66,255,209,.16), rgba(66,255,209,0)); padding:.65em 1em; border-radius:12px; color:var(--txt); cursor:pointer; font-weight:700}
  .btn:hover{border-color:var(--accent); box-shadow:0 0 0 1px rgba(0,255,156,.22) inset}
  .btn.primary{background:linear-gradient(180deg, rgba(0,255,156,.34), rgba(0,255,156,.18)); color:#eafff6; text-shadow:0 1px 0 rgba(0,0,0,.6); font-weight:800}

  section{display:none; content-visibility:auto; contain-intrinsic-size: 1px 1000px}
  section.active{display:block}

  /* Grids */
  .grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:var(--grid); content-visibility:auto}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2, 1fr)} }
  @media (max-width:620px){ .grid{grid-template-columns:1fr} }
  .proj{overflow:hidden}
  .thumb{position:relative; aspect-ratio:16/9; overflow:hidden; border-radius:14px; border:1px solid rgba(66,255,209,.26)}
  .thumb.poster{aspect-ratio:2/3}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block}
  .proj .meta{padding:.7em .9em 1em}
  .proj .title{font-weight:800; color:#e2fff5}
  .proj .role{color:var(--muted); font-size:.9em}
  footer{opacity:.85; font-size:.9em; padding:clamp(28px,2.5vw,40px) 0 20px}

  #professional .grid{grid-template-columns:repeat(4, 1fr)}
  @media (max-width:1100px){ #professional .grid{grid-template-columns:repeat(3, 1fr)} }
  @media (max-width:820px){ #professional .grid{grid-template-columns:repeat(2, 1fr)} }
  @media (max-width:520px){ #professional .grid{grid-template-columns:1fr} }

  details.summaryless > summary{list-style:none}
  details.summaryless > summary::-webkit-details-marker{display:none}
</style>
</head>
<body>
<div id="appRoot"><!-- everything inside this wrapper to prevent duplicates -->

  <!-- Banner -->
  <div class="banner">
    <div class="ctrl prev"><button id="bnPrev" aria-label="Previous">◀</button></div>
    <div class="ctrl next"><button id="bnNext" aria-label="Next">▶</button></div>
    <div class="rail card" id="bannerRail" aria-label="Featured work carousel">
      <div class="scroll" id="bannerScroll" role="list"></div>
    </div>
  </div>

  <div class="wrap">
    <!-- NAV -->
    <div class="nav">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <h1 id="siteTitle" class="crt-glow">Loading data for SUBJECT: ARI FEBLOWITZ</h1>
        <span id="siteSubtitle" class="pill crt-glow">Techvis & Virtual Production Supervisor</span>
        <a id="sysStatus" class="pill crt-glow" href="https://linktr.ee/admin/links" target="_blank" rel="noopener">Routing request to MOTHER…</a>
      </div>
    </div>

    <!-- Sticky tabs -->
    <div class="tabs-bar" role="tablist" aria-label="Sections">
      <button class="tab-btn active" data-tab="home" role="tab" aria-selected="true">Home</button>
      <button class="tab-btn" data-tab="professional" role="tab" aria-selected="false">Professional Work</button>
      <button class="tab-btn" data-tab="rides" role="tab" aria-selected="false">Rides</button>
      <button class="tab-btn" data-tab="personal" role="tab" aria-selected="false">Personal Work</button>
    </div>

    <!-- HOME -->
    <section id="home" class="active" role="tabpanel">
      <div class="hero">
        <div class="card pad">
          <h2 id="reelHeader" class="crt-glow" style="margin:0 0 .6em">Initializing video uplink…</h2>
          <div class="reel" id="reelBox">
            <iframe id="reelFrame" src="" title="Ari Feblowitz — Demo Reel" frameborder="0" loading="lazy" decoding="async" fetchpriority="low" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          </div>
          <div class="badges">
            <a id="btnIMDb" class="btn" href="https://www.imdb.me/ArielFeblowitz" target="_blank" rel="noopener">IMDb</a>
            <a id="btnYouTube" class="btn" href="https://www.youtube.com/@DirectorPsycho" target="_blank" rel="noopener">YouTube</a>
            <a id="btnLinks" class="btn" href="https://linktr.ee/admin/links" target="_blank" rel="noopener">All My Links</a>
            <a id="btnResume" class="btn primary" href="#" download>Download Résumé</a>
            <a id="btnNews" class="btn" href="https://www.youtube.com/watch?v=gM5H6vsGIcs" target="_blank" rel="noopener">Ari in the News</a>
          </div>
        </div>

        <div class="card pad">
          <h2 id="aboutHeader" class="crt-glow" style="margin:0 0 .6em">Subject dossier…</h2>
          <p class="muted crt-glow" id="aboutStatus" style="margin:.2em 0 .8em">Initializing: Weyland Yutani–Cyberdyne link…</p>
          <p id="about1">Bridging virtual and physical storytelling across techvis, previs/postvis, and virtual production. I translate complex sequences into precise, repeatable camera plans — trusted by directors, DPs, and VFX supervisors.</p>
          <p id="about2" class="muted">Credits include Avatar: The Way of the Water, Avengers: Endgame, Ant-Man and the Wasp, Guardians of the Galaxy Vol. 3, and more.</p>
          <div id="skillsRow1" class="badges"></div>
          <div id="skillsRow2" class="badges"></div>
        </div>
      </div>
    </section>

    <!-- PROFESSIONAL -->
    <section id="professional" role="tabpanel">
      <div class="card pad">
        <div class="nav" style="gap:8px; justify-content:space-between; align-items:flex-end">
          <h2 class="crt-glow" style="margin:0">Professional Projects</h2>
          <small class="muted">Selected credits</small>
        </div>
        <div id="proGrid" class="grid"></div>
      </div>
    </section>

    <!-- RIDES -->
    <section id="rides" role="tabpanel">
      <div class="card pad">
        <div class="nav" style="gap:8px; justify-content:space-between; align-items:flex-end">
          <h2 class="crt-glow" style="margin:0">Rides</h2>
          <small class="muted">Themed entertainment</small>
        </div>
        <div id="ridesGrid" class="grid"></div>
      </div>
    </section>

    <!-- PERSONAL -->
    <section id="personal" role="tabpanel">
      <div class="card pad">
        <div class="nav" style="gap:8px; justify-content:space-between; align-items:flex-end">
          <h2 class="crt-glow" style="margin:0">Personal Work</h2>
          <small class="muted">Original shorts & experiments</small>
        </div>
        <div id="personalGrid" class="grid"></div>

        <div class="card pad" id="febzBox" style="margin-top:var(--grid); display:none">
          <h3 class="crt-glow" style="margin-top:0"><span id="febzHeading"></span> <a href="https://www.youtube.com/@FebzFoundFootage" target="_blank" rel="noopener">@FebzFoundFootage</a></h3>
          <a id="febzLink" href="#" target="_blank" rel="noopener" class="thumb" style="display:block; aspect-ratio:16/9;">
            <img id="febzThumb" alt="FebzFoundFootage — Featured" loading="lazy" decoding="async" fetchpriority="low" style="width:100%; height:100%; object-fit:cover; display:block; border-radius:14px; border:1px solid rgba(66,255,209,.26)" />
          </a>
          <small id="febzBody" class="muted"></small>
        </div>

        <div class="card pad" id="latestBox" style="margin-top:var(--grid); display:none">
          <h3 class="crt-glow" style="margin-top:0">Latest from YouTube</h3>
          <div class="reel" style="aspect-ratio:16/9">
            <iframe id="latestFrame" src="" title="YouTube uploads" frameborder="0" loading="lazy" decoding="async" fetchpriority="low" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          </div>
        </div>
      </div>
    </section>

    <footer class="muted">© <span id="year"></span> Ariel (Ari) Feblowitz • WY–Cyberdyne Systems in compliance with Weyland Yutani Mother Ai - Hosted from Skynet • Theme: Tech-Noir</footer>
  </div><!-- /#appRoot -->

<script>
/* =========================
   SINGLETON + DEDUPE GUARD
   ========================= */
(function guard(){
  const roots = document.querySelectorAll('#appRoot');
  if (roots.length > 1){
    roots.forEach((el, i)=>{ if(i>0) el.remove(); });
  }
  if (window.__siteInitDone) { console.warn('Init already run; skipping.'); return; }
  window.__siteInitDone = true;
})();

/**********************
  SHEET SETTINGS
***********************/
const PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxBxTbb-Ax7rpnnn5zWDUW6fGq1nUGIEPJb5qfaxifqKyZexNLK28gwpQLS5T5vpeuSvZicAEg69U1/pubhtml";
const TAB_MAP = {};

/**********************
  UTILITIES
***********************/
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
const ytThumb = id => `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
const ytMax = id => `https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
const fixImdb  = url => (url||"").replace(/https?:\/\/pro\.imdb\.com/i,'https://www.imdb.com').replace(/\?ref_=pro.*$/,'');

function csvToObjects(csvText){
  const rows = []; let field="", row=[], inQ=false;
  for (let c of String(csvText||"").replace(/\r/g,'')){
    if (c==='"'){ inQ = !inQ; field+=c; }
    else if (c===',' && !inQ){ row.push(field.replace(/^"|"$/g,'').replace(/""/g,'"')); field=""; }
    else if (c==='\n' && !inQ){ row.push(field.replace(/^"|"$/g,'').replace(/""/g,'"')); rows.push(row); row=[]; field=""; }
    else field+=c;
  }
  if (field.length || row.length){ row.push(field.replace(/^"|"$/g,'').replace(/""/g,'"')); rows.push(row); }
  if (!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=>r.length>1).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]!==undefined?r[i]:""); return o; });
}
const normBool = v => String(v||"").trim().toLowerCase()==='true' || String(v||"").trim().toLowerCase()==='yes';
const normNum  = v => { const n = Number(String(v||"").replace(/[^\d.-]/g,"")); return isNaN(n)?0:n; };
function buildCsvUrlFromGid(pubhtml, gid){ return pubhtml.replace(/\/pubhtml.*/, '/pub') + `?gid=${gid}&single=true&output=csv`; }

/* Local cache */
const cache = {
  get(key){ try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch{return null} },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
};

async function discoverGids(pubhtml){
  const map = {}; try{
    const html = await fetch(pubhtml, {mode:"cors"}).then(r=>r.text());
    const uniqueGids = [...new Set([...html.matchAll(/gid=(\d+)/g)].map(m=>m[1]))];
    for (const gid of uniqueGids){
      const txt = await fetch(buildCsvUrlFromGid(pubhtml, gid)).then(r=>r.text()).catch(()=>null);
      if (!txt) continue; const rows = csvToObjects(txt); const hdr = Object.keys(rows[0]||{}).join('|').toLowerCase();
      if (hdr.includes('primary image') && hdr.includes('on set?')) map['Ariel_Feblowitz_Works']=gid;
      else if (hdr.includes('ride image') && hdr.includes('ride name')) map['Rides']=gid;
      else if (hdr.includes('type') && hdr.includes('video_id')) map['Personal Youtube']=gid;
      else if (hdr.includes('key') && hdr.includes('value')) map['Main site info']=gid;
    }
  }catch(e){}
  return { ...map, ...TAB_MAP };
}

function titlePlaceholderSVG(title){
  const safe = (title||'Untitled').replace(/&/g,'&amp;').replace(/</g,'&lt;');
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 800'>
    <rect width='100%' height='100%' fill='#000'/>
    <text x='50%' y='50%' fill='#9fffcf' font-family='Inter, Segoe UI, Roboto, Arial, sans-serif' font-size='36' text-anchor='middle' dominant-baseline='middle'>${safe}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/**********************
  BANNER (arrows + hover pause; click opens link)
***********************/
const rail = $('#bannerRail');
const scrollEl = $('#bannerScroll');
let autoRAF=null, paused=false, lastT=0;

function makeImg(src, alt){
  const img = new Image();
  img.alt = alt || '';
  img.loading = 'lazy';
  img.decoding = 'async';
  img.fetchPriority = 'low';
  img.src = src;
  return img;
}
function makeTile(t){
  const a=document.createElement('a');
  a.className='tile ' + (t.type==='pro'?'poster':'wide');
  a.href=t.url||'#'; a.target='_blank'; a.rel='noopener';
  a.setAttribute('data-title', t.title||'');
  a.appendChild(makeImg(t.img || titlePlaceholderSVG(t.title), t.title||''));
  return a;
}
function fillBanner(tiles){
  scrollEl.innerHTML='';
  const seq=[...tiles];
  [...seq, ...seq].forEach(t=> scrollEl.appendChild(makeTile(t))); // duplicate for seamless loop
  startAuto();
}
function step(ts){
  if (paused) { autoRAF=requestAnimationFrame(step); return; }
  if (!lastT) lastT=ts; const dt=(ts-lastT)/1000; lastT=ts;
  const pxPerSec = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--speed')) || 55;
  rail.scrollLeft += pxPerSec * dt;
  const half = scrollEl.scrollWidth/2;
  if (rail.scrollLeft >= half) rail.scrollLeft -= half; // loop
  autoRAF=requestAnimationFrame(step);
}
function startAuto(){ cancelAnimationFrame(autoRAF); lastT=0; autoRAF=requestAnimationFrame(step); }
function pauseAuto(p=true){ paused=p; }
rail.addEventListener('mouseenter', ()=>pauseAuto(true));
rail.addEventListener('mouseleave', ()=>pauseAuto(false));
$('#bnPrev').addEventListener('click', ()=>{ rail.scrollLeft -= 260; });
$('#bnNext').addEventListener('click', ()=>{ rail.scrollLeft += 260; });

/**********************
  TABS + YEAR + STATUS
***********************/
$$('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tab-btn').forEach(b=>{ b.classList.toggle('active', b===btn); b.setAttribute('aria-selected', b===btn) });
    const name = btn.dataset.tab; $$('section').forEach(s=>s.classList.toggle('active', s.id===name));
    if (!loaded.sections) { loadSections(); } // lazy fetch on first tab use if idle didn't run yet
    window.scrollTo({ top: $('.wrap').offsetTop, behavior: 'smooth' });
  });
});
$('#year').textContent = new Date().getFullYear();

const sysStatus = document.getElementById('sysStatus');
function setStatus(msg, linkHref){
  if (!sysStatus) return;
  sysStatus.textContent = msg;
  if (linkHref) { sysStatus.href = linkHref; }
}

/**********************
  PHASED LOAD
***********************/
const loaded = { main:false, reel:false, sections:false, banner:false };

(async function init(){
  setStatus('Routing request to MOTHER…', sysStatus.href);

  const gids = await discoverGids(PUBHTML);

  async function pullTab(name){
    const gid = gids[name]; if(!gid) return [];
    const key = `csv:${gid}`;
    const cached = cache.get(key); if (cached && cached.txt){
      try { return csvToObjects(cached.txt); } catch{}
    }
    const txt = await fetch(buildCsvUrlFromGid(PUBHTML, gid)).then(r=>r.text());
    cache.set(key, {ts:Date.now(), txt});
    return csvToObjects(txt);
  }

  /* Phase 1: Main info fast */
  const mainInfoRows = await pullTab('Main site info');
  const mainInfo = {}; (mainInfoRows||[]).forEach(r=> mainInfo[(r.key||'').trim()]=(r.value||'').trim());

  $('#siteTitle').textContent = mainInfo.site_title || 'Ariel (Ari) Feblowitz';
  $('#siteSubtitle').textContent = mainInfo.site_subtitle || 'Techvis & Virtual Production Supervisor';
  $('#about1').textContent = mainInfo.about_paragraph_1 || $('#about1').textContent;
  $('#about2').textContent = mainInfo.about_paragraph_2 || $('#about2').textContent;

  const linksHref = mainInfo.all_links_url || 'https://linktr.ee/admin/links';
  $('#btnIMDb').href    = fixImdb(mainInfo.imdb_url || $('#btnIMDb').href);
  $('#btnYouTube').href = mainInfo.youtube_url || $('#btnYouTube').href;
  $('#btnLinks').href   = linksHref;
  if (mainInfo.news_url) $('#btnNews').href = mainInfo.news_url;
  if (mainInfo.resume_url) $('#btnResume').href = mainInfo.resume_url;

  setStatus('Link established', linksHref);
  const aboutStatus = $('#aboutStatus'); if (aboutStatus) aboutStatus.style.display = 'none';
  document.body.classList.add('ready');
  $('#reelHeader').textContent = 'Demo Reel';
  $('#aboutHeader').textContent = 'About';
  loaded.main = true;

  // Skills pills
  const skills = (mainInfo.skills||'').split('|').map(s=>s.trim()).filter(Boolean);
  const half = Math.ceil(skills.length/2);
  const pill = t => { const s=document.createElement('span'); s.className='pill'; s.textContent=t; return s; };
  const row1=$('#skillsRow1'), row2=$('#skillsRow2');
  skills.slice(0,half).forEach(s=>row1.appendChild(pill(s)));
  skills.slice(half).forEach(s=>row2.appendChild(pill(s)));

  /* Phase 2: Reel */
  (function loadReel(){
    const reelInput = (mainInfo.reel_youtube_id||'').trim();
    const reelFrame = $('#reelFrame');
    const reelBox = $('#reelBox');
    const setIframe = src => { reelFrame.loading='lazy'; reelFrame.decoding='async'; reelFrame.fetchPriority='low'; reelFrame.src = src; };

    if (/^\s*<iframe/i.test(reelInput)){ reelBox.innerHTML = reelInput; loaded.reel=true; return; }
    const vimeoM = reelInput.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
    if (vimeoM){ setIframe(`https://player.vimeo.com/video/${vimeoM[1]}?badge=0&autopause=0&title=0&byline=0`); loaded.reel=true; return; }
    if (/^\d{7,}$/.test(reelInput)){ setIframe(`https://player.vimeo.com/video/${reelInput}?badge=0&autopause=0&title=0&byline=0`); loaded.reel=true; return; }
    const ytM = reelInput.match(/[?&]v=([\w-]{6,})/) || reelInput.match(/youtu\.be\/([\w-]{6,})/);
    if (ytM){ setIframe(`https://www.youtube.com/embed/${ytM[1]}?rel=0&modestbranding=1`); loaded.reel=true; return; }
    if (/^[\w-]{6,}$/.test(reelInput)){ setIframe(`https://www.youtube.com/embed/${reelInput}?rel=0&modestbranding=1`); loaded.reel=true; return; }
    reelFrame.srcdoc = `<style>body{margin:0;display:grid;place-items:center;background:#000;color:#9fb5b8;font:16px system-ui}.box{opacity:.8;text-align:center}.box b{color:#fff}</style><div class='box'>Add your <b>reel</b> (YouTube or Vimeo) in the "Main site info" tab.</div>`;
    loaded.reel=true;
  })();

  /* Phase 3: Sections (defer to idle, else on first tab click) */
  const defer = window.requestIdleCallback || (fn=>setTimeout(fn, 0));
  defer(loadSections);

  /* Phase 4: Banner after sections (double-defer) */
  defer(()=> setTimeout(buildBannerDeferred, 400));

  async function loadSections(){
    if (loaded.sections) return;
    loaded.sections = true;

    const [personalTab, proRows, ridesRows] = await Promise.all([
      pullTab('Personal Youtube'),
      pullTab('Ariel_Feblowitz_Works'),
      pullTab('Rides')
    ]);

    // Personal meta & videos
    const meta = {}; const videos=[];
    (personalTab||[]).forEach(r=>{
      const type=(r.type||'').toLowerCase();
      if (type==='meta'){ meta[(r.key||'').trim()] = (r.value||'').trim(); }
      else if (type==='video'){
        const videoId=(r.video_id||'').trim();
        const url=(r.youtube_url||'').trim() || (videoId?`https://www.youtube.com/watch?v=${videoId}`:'');
        const thumb=(r.thumb_url||'').trim() || (videoId? ytThumb(videoId) : '');
        videos.push({ prio:normNum(r.prio), includeInBanner: normBool(r.include_in_banner) || normNum(r.prio)>=5,
          featured: normBool(r.featured), videoId, title:(r.title||'').trim(), role:(r.role||'').trim(), url, thumb });
      }
    });

    const featuredId = (meta.featured_video_id || (videos.find(v=>v.featured)?.videoId) || '').trim();
    const showLatest = (String(meta.latest_mode||'').toLowerCase()==='auto') || false;
    if (showLatest && meta.latest_playlist_or_channel_id){
      const channelId = meta.latest_playlist_or_channel_id;
      if (channelId.startsWith('UC')){
        const uploadsId = 'UU'+channelId.slice(2);
        $('#latestFrame').src = `https://www.youtube.com/embed/videoseries?list=${uploadsId}&rel=0`;
        $('#latestBox').style.display = 'block';
      }
    }

    // Professional
    const proItems = (proRows||[]).map(r=>({
      title:(r['Name']||'').trim(), url:fixImdb((r['URL']||'').trim()), role:(r['My Role']||'').trim(),
      prod:(r['Production Co.']||'').trim(), onSet:normBool(r['On Set?']), prio:normNum(r['Prio?']),
      posters:[(r['Primary image']||'').trim()].filter(Boolean)
    })).filter(x=>x.title && x.prio>0)
      .sort((a,b)=> (a.onSet!==b.onSet)? (a.onSet? -1:1) : (b.prio-a.prio) || a.title.localeCompare(b.title));

    // Rides
    const rideItems = (ridesRows||[]).map(r=>({
      title:(r['Ride Name']||'').trim(), url:(r['Ride Link']||'').trim(), role:(r['My Role']||'').trim(),
      company:(r['Ride Company']||'').trim(), desc:(r['Description']||'').trim(), prio:normNum(r['Prio']),
      posters:[(r['Ride Image']||'').trim()].filter(Boolean)
    })).filter(x=>x.title && x.prio>0)
      .sort((a,b)=> b.prio-a.prio || a.title.localeCompare(b.title));

    renderPro(proItems);
    renderRides(rideItems);
    renderPersonal(videos, featuredId);

    // Save for banner building
    window.__tilesData = {
      pro: proItems.filter(p=>p.prio>=5).map(p=>({type:'pro', title:p.title, img:p.posters[0]||'', url:p.url||'#'})),
      ride: rideItems.filter(r=>r.prio===10).map(r=>({type:'ride', title:r.title, img:r.posters[0]||'', url:r.url||'#'})),
      per: videos.filter(v=>(v.prio||0)>=5 || v.includeInBanner).map(v=>({type:'personal', title:v.title, img:v.thumb||'', url:v.url||'#'}))
    };
  }

  function renderPro(items){
    const grid = $('#proGrid'); grid.innerHTML='';
    if (!items.length){ grid.innerHTML = `<div class="muted">No items yet — add rows in the “Ariel_Feblowitz_Works” tab.</div>`; return; }
    items.forEach(p=>{
      const c=document.createElement('a'); c.className='proj card'; c.href=p.url||'#'; c.target='_blank'; c.rel='noopener';
      const wrap=document.createElement('div'); wrap.className='thumb poster';
      const img=new Image(); img.alt=''; img.loading='lazy'; img.decoding='async'; img.fetchPriority='low';
      img.src = p.posters[0] || titlePlaceholderSVG(p.title);
      wrap.appendChild(img);
      const meta=document.createElement('div'); meta.className='meta';
      const info=[p.role, p.prod].filter(Boolean).join(' • ');
      meta.innerHTML = `<div class="title">${p.title}</div><div class="role">${info}</div>`;
      c.appendChild(wrap); c.appendChild(meta); grid.appendChild(c);
    });
  }

  function renderRides(items){
    const grid = $('#ridesGrid'); grid.innerHTML='';
    if (!items.length){ grid.innerHTML = `<div class="muted">No items yet — add rows in the “Rides” tab.</div>`; return; }
    items.forEach(p=>{
      const c=document.createElement('a'); c.className='proj card'; c.href=p.url||'#'; c.target='_blank'; c.rel='noopener';
      const wrap=document.createElement('div'); wrap.className='thumb';
      const img=new Image(); img.alt=''; img.loading='lazy'; img.decoding='async'; img.fetchPriority='low';
      img.src = p.posters[0] || titlePlaceholderSVG(p.title);
      wrap.appendChild(img);
      const meta=document.createElement('div'); meta.className='meta';
      const info=[p.role, p.company].filter(Boolean).join(' • ');
      let body='';
      if (p.desc){
        body = `<details class="summaryless" style="margin-top:.45em; font-size:.95em">
                  <summary class="btn" style="display:inline-flex; margin:0; padding:.35em .6em;">Details</summary>
                  <div class="muted" style="margin-top:.6em">${p.desc}</div>
                </details>`;
      }
      meta.innerHTML = `<div class="title">${p.title}</div><div class="role">${info}</div>${body}`;
      c.appendChild(wrap); c.appendChild(meta); grid.appendChild(c);
    });
  }

  function renderPersonal(videos, featuredId){
    const grid = $('#personalGrid'); grid.innerHTML='';
    if (!videos.length){ grid.innerHTML = `<div class="muted">No videos yet — add rows in the “Personal Youtube” tab.</div>`; return; }
    const fIdx = videos.findIndex(v=>v.videoId===featuredId); if (fIdx>0){ const [f]=videos.splice(fIdx,1); videos.unshift(f); }
    videos.forEach(v=>{
      const c=document.createElement('a'); c.className='proj card'; c.href=v.url||'#'; c.target='_blank'; c.rel='noopener';
      const wrap=document.createElement('div'); wrap.className='thumb';
      const img=new Image(); img.alt=''; img.loading='lazy'; img.decoding='async'; img.fetchPriority='low';
      img.src = v.thumb || (v.videoId? ytThumb(v.videoId) : titlePlaceholderSVG(v.title));
      wrap.appendChild(img);
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div class="title">${v.title||''}</div><div class="role">${v.role||''}</div>`;
      c.appendChild(wrap); c.appendChild(meta); grid.appendChild(c);
    });
  }

  function buildBannerDeferred(){
    if (loaded.banner || !window.__tilesData) return;
    loaded.banner = true;
    const {pro, ride, per} = window.__tilesData;
    const interleaved=[]; const L=Math.max(pro.length, ride.length, per.length);
    for(let i=0;i<L;i++){ if(pro[i]) interleaved.push(pro[i]); if(ride[i]) interleaved.push(ride[i]); if(per[i]) interleaved.push(per[i]); }
    fillBanner(interleaved);
  }
})();
</script>
</body>
</html>
