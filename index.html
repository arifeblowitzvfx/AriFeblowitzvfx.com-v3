/* ============ TESTIMONIALS (REBUILT, STACK ALL ROWS) ============ */
{
  const tBox   = document.getElementById('testimonialsBox');
  const tList  = document.getElementById('testimonialsList');
  const tTitle = document.getElementById('testimonialsTitle');

  const matrix = testiPull.matrix || [];
  const raw    = testiPull.raw || '';

  // 1) Title from B1 *only if* row 0 is NOT the header row.
  const looksLikeHeader = (cells) => {
    const low = cells.map(c => String(c||'').trim().toLowerCase());
    const hasFrom = low.includes('from');
    const hasText = ['testimonial','testimonials','quote','text','body']
      .some(k => low.includes(k));
    return hasFrom && hasText;
  };

  const b1 = (()=>{
    const rows = (raw || '').split(/\r?\n/);
    if (!rows.length) return '';
    const firstRow = rows[0] || '';
    // A super-quick parse of first line → second column
    const parts = []; let f='', inQ=false;
    for (let i=0;i<firstRow.length;i++){
      const ch = firstRow[i];
      if (ch === '"'){ inQ = !inQ; f+=ch; continue; }
      if (!inQ && ch===','){ parts.push(f); f=''; continue; }
      f+=ch;
    }
    parts.push(f);
    return parts[1] ? String(parts[1]).replace(/^"+|"+$/g,'').trim() : '';
  })();

  // 2) Find the header row anywhere in the sheet.
  let headerRowIdx = -1;
  for (let i=0; i<matrix.length; i++){
    const row = matrix[i] || [];
    if (row.length && looksLikeHeader(row)) { headerRowIdx = i; break; }
  }
  if (headerRowIdx === -1) headerRowIdx = 0; // fallback

  // 3) Build a case/space-insensitive column map.
  const header = (matrix[headerRowIdx] || []).map(h => String(h||'').trim());
  const idxMap = {};
  header.forEach((h, i) => { idxMap[h.toLowerCase()] = i; });

  function getIdx(...names){
    for (const n of names){
      const k = String(n||'').trim().toLowerCase();
      if (k in idxMap) return idxMap[k];
    }
    // try forgiving matches (extra spaces, pluralization)
    for (const k in idxMap){
      const kk = k.replace(/\s+/g,'');
      for (const n of names){
        const target = String(n||'').toLowerCase().replace(/\s+/g,'');
        if (kk === target) return idxMap[k];
      }
    }
    return -1;
  }

  const fromIdx = getIdx('From');
  const linkIdx = getIdx('Link', 'URL', 'Hyperlink');
  const prioIdx = getIdx('Prio','Priority','prio','priority');
  // text columns, in priority order:
  const textIdxs = [
    getIdx('Testimonial'), getIdx('Testimonials'),
    getIdx('Quote'), getIdx('Text'), getIdx('Body')
  ].filter(i => i >= 0);

  // 4) Extract items from all data rows after headerRowIdx.
  const items = [];
  for (let r = headerRowIdx + 1; r < matrix.length; r++){
    const row = matrix[r] || [];
    if (!row.length || row.every(x => !String(x||'').trim())) continue;

    const from = fromIdx >= 0 ? String(row[fromIdx]||'').trim() : '';
    let text = '';
    for (const ti of textIdxs){
      const candidate = String(row[ti]||'').trim();
      if (candidate){ text = candidate; break; }
    }
    if (!from || !text) continue;

    const link = linkIdx >= 0 ? String(row[linkIdx]||'').trim() : '';
    let prio = 0;
    if (prioIdx >= 0){
      const rawPr = String(row[prioIdx]||'');
      prio = Number(rawPr.replace(/[^\d.-]/g,'')) || 0;
    }
    // normalize whitespace in long quotes
    text = text.replace(/\s*\n\s*/g, ' ').replace(/\s{2,}/g, ' ').trim();

    items.push({ from, text, link, prio });
  }

  // 5) Title handling
  const firstRowLooksHeader = looksLikeHeader(matrix[0] || []);
  const heading = !firstRowLooksHeader && b1 ? b1 : 'Testimonials';
  tTitle.textContent = heading;

  // 6) Sort if any prio>0, otherwise keep sheet order
  if (items.some(i => i.prio > 0)){
    items.sort((a,b) => b.prio - a.prio);
  }

  // 7) Render stacked cards
  const smartQuote = (s) => {
    const t = String(s||'').trim();
    const b = /^["“]/.test(t), e = /["”]$/.test(t);
    return (b && e) ? t : `“${t.replace(/^["“'‘`]/,'').replace(/["”'’`]$/,'')}”`;
  };
  const esc = (s) => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

  if (items.length){
    tList.innerHTML = '';
    items.forEach(it => {
      const fromLabel = it.link ? `<a href="${esc(it.link)}" target="_blank" rel="noopener">${esc(it.from)}</a>` : esc(it.from);
      const el = document.createElement('div');
      el.className = 'testimonial';
      el.innerHTML = `<span class="quote">${esc(smartQuote(it.text))}</span><span class="from">— ${fromLabel}</span>`;
      tList.appendChild(el);
    });
    tBox.style.display = 'block';
  } else {
    // If nothing valid, hide the box entirely rather than showing a lone gag.
    tBox.style.display = 'none';
  }

  loaded.testimonials = true;
}
/* ========== END TESTIMONIALS ========== */
